datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("PATIENT") // ADMIN, PATIENT, PROVIDER, CONCIERGE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientProfile   PatientProfile?
  providerProfile  ProviderProfile?
  conciergeProfile ConciergeProfile?
  auditLogs        AuditLog[]
  uploadedLabFiles LabFile[]
}

model PatientProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  firstName String
  lastName  String
  dob       DateTime
  gender    String   // MALE, FEMALE
  phone     String?
  address   String?

  labResults    LabResult[]
  labPanels     LabPanel[]    // New lab infrastructure
  orders        Order[]
  clinicalNotes ClinicalNote[]
  quotes        Quote[]

  goals         PatientGoal[]
  regimen       ActiveRegimen[]
  wearableData  WearableData[]
  checkIns      CheckIn[]
}

model PatientGoal {
  id        String   @id @default(uuid())
  patientId String
  patient   PatientProfile @relation(fields: [patientId], references: [id])
  
  type        String // SHORT_TERM, MEDIUM_TERM
  description String
  status      String @default("ACTIVE") // ACTIVE, ACHIEVED, ARCHIVED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ActiveRegimen {
  id        String   @id @default(uuid())
  patientId String
  patient   PatientProfile @relation(fields: [patientId], references: [id])
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  
  name      String // If product is null, use this (e.g. external med)
  dosage    String?
  frequency String?
  type      String // SUPPLEMENT, RX
  source    String @default("EXTERNAL") // INTERNAL (from Invoice), EXTERNAL (Patient reported)
  
  active    Boolean @default(true)
  startDate DateTime?
  endDate   DateTime?
  
  notes     String?
  
  adherenceHistory RegimenAdherence[]
}

model WearableData {
  id        String   @id @default(uuid())
  patientId String
  patient   PatientProfile @relation(fields: [patientId], references: [id])
  
  source    String // OURA, WHOOP, APPLE_HEALTH
  date      DateTime
  
  // JSON blob for flexibility as APIs change
  // Structure: { sleepScore: 85, hrv: 45, steps: 10000 }
  metrics   String 
  
  syncedAt  DateTime @default(now())
}

model ProviderProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  firstName String
  lastName  String
  specialty String?
  deaNumber String?

  reviewedLabs       LabResult[]
  reviewedLabPanels  LabPanel[]  @relation("LabPanelReviewer")
  authoredNotes      ClinicalNote[]
}

model ConciergeProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  firstName String
  lastName  String
  
  draftedNotes  ClinicalNote[]
  createdQuotes Quote[]
}

model ClinicalNote {
  id        String   @id @default(uuid())
  patientId String
  patient   PatientProfile @relation(fields: [patientId], references: [id])
  
  providerId  String?
  provider    ProviderProfile? @relation(fields: [providerId], references: [id])
  
  conciergeId String?
  concierge   ConciergeProfile? @relation(fields: [conciergeId], references: [id])

  status      String   @default("DRAFT") // DRAFT, PENDING_REVIEW, FINALIZED
  
  // SOAP Note Structure
  chiefComplaint String? // Subjective (Concierge)
  history        String? // Subjective (Concierge) - Lifestyle, Meds
  subjective     String? // Subjective (Concierge/Provider)
  objective      String? // Objective (Provider) - Physical exam, Lab review
  assessment     String? // Assessment (Provider)
  plan           String? // Plan (Provider) - Rx, Supplements

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LabResult {
  id         String   @id @default(uuid())
  patientId  String
  patient    PatientProfile @relation(fields: [patientId], references: [id])
  providerId String?
  provider   ProviderProfile? @relation(fields: [providerId], references: [id])
  testDate   DateTime
  uploadedAt DateTime @default(now())
  status     String   @default("PENDING_REVIEW") // PENDING_REVIEW, REVIEWED

  biomarkers Biomarker[]
}

model Biomarker {
  id        String   @id @default(uuid())
  labId     String
  lab       LabResult @relation(fields: [labId], references: [id])
  name      String
  value     Float
  unit      String
  rangeLow  Float?
  rangeHigh Float?
  flag      String? // HIGH, LOW, NORMAL
}

// ===========================================
// NEW LAB INFRASTRUCTURE (v2)
// ===========================================

model LabPanel {
  id              String   @id @default(uuid())
  patientId       String
  patient         PatientProfile @relation(fields: [patientId], references: [id])

  labType         String   @default("BLOOD_PANEL") // BLOOD_PANEL, HORMONE_PANEL, GENETIC_TEST, GUT_HEALTH, URINALYSIS, OTHER
  provider        String   @default("OTHER") // QUEST, LABCORP, ACCESS_MEDICAL, INTERNAL, OTHER
  providerLabId   String?  // External reference ID from lab provider
  panelName       String   // "Comprehensive Metabolic Panel"

  collectionDate  DateTime // When blood was drawn
  receivedDate    DateTime?
  reportDate      DateTime?
  uploadedAt      DateTime @default(now())

  status          String   @default("PENDING_UPLOAD") // PENDING_UPLOAD, PROCESSING, PENDING_REVIEW, REVIEWED, FLAGGED
  processingStatus String? // QUEUED, EXTRACTING, EXTRACTED, NORMALIZED, FAILED, MANUAL_ENTRY
  processingError String?

  reviewedById    String?
  reviewedBy      ProviderProfile? @relation("LabPanelReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  reviewNotes     String?

  originalFileId  String?
  originalFile    LabFile? @relation(fields: [originalFileId], references: [id])

  results         LabResultValue[]
  metadata        String?  // JSON for additional data

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([patientId, collectionDate])
  @@index([status])
  @@index([provider])
}

model LabFile {
  id               String   @id @default(uuid())
  storageProvider  String   // "s3", "local"
  bucket           String?  // S3 bucket name
  key              String   // File path/key
  originalFilename String
  mimeType         String   // "application/pdf"
  fileSize         Int      // Bytes
  checksum         String?  // MD5 for integrity

  ocrText          String?  // Raw OCR output
  extractedData    String?  // JSON of extracted values

  uploadedById     String
  uploadedBy       User     @relation(fields: [uploadedById], references: [id])
  uploadedAt       DateTime @default(now())

  labPanels        LabPanel[]

  @@index([key])
}

model BiomarkerCatalog {
  id                   String   @id @default(uuid())
  code                 String   @unique // TOTAL_TESTOSTERONE, HBA1C
  name                 String   // "Total Testosterone"
  category             String   // "Hormone Profile", "Metabolic"
  subcategory          String?  // "Androgens", "Thyroid"

  defaultUnit          String   // "ng/dL"

  // Adonis optimal ranges (tighter than lab reference)
  optimalRangeLow      Float?
  optimalRangeHigh     Float?

  // Standard lab reference ranges
  refRangeLow          Float?
  refRangeHigh         Float?

  // Gender-specific ranges JSON: { "MALE": { low: 300, high: 1000 }, "FEMALE": { low: 15, high: 70 } }
  genderSpecificRanges String?

  // Age-specific ranges JSON: { "30-40": { low: 400, high: 900 } }
  ageSpecificRanges    String?

  description          String?  // Clinical description
  clinicalNotes        String?  // Provider notes about interpretation

  displayOrder         Int      @default(0)
  isActive             Boolean  @default(true)

  aliases              BiomarkerAlias[]
  results              LabResultValue[]

  @@index([category])
  @@index([code])
}

model BiomarkerAlias {
  id               String   @id @default(uuid())
  biomarkerId      String
  biomarker        BiomarkerCatalog @relation(fields: [biomarkerId], references: [id])

  labProvider      String   // QUEST, LABCORP, ACCESS_MEDICAL
  aliasName        String   // "Testosterone, Total" (Quest naming)
  aliasCode        String?  // Lab-specific test code "873"

  // Unit conversion if lab uses different units
  labUnit          String?
  conversionFactor Float    @default(1.0) // Multiply lab value by this

  // Lab-specific reference ranges
  labRefRangeLow   Float?
  labRefRangeHigh  Float?

  @@unique([biomarkerId, labProvider, aliasName])
  @@index([aliasName])
  @@index([labProvider])
}

model LabResultValue {
  id               String   @id @default(uuid())
  labPanelId       String
  labPanel         LabPanel @relation(fields: [labPanelId], references: [id], onDelete: Cascade)

  biomarkerId      String
  biomarker        BiomarkerCatalog @relation(fields: [biomarkerId], references: [id])

  // Raw value from lab report
  rawValue         String   // Store original (could be "<5" or "Negative")
  rawUnit          String?

  // Normalized value
  numericValue     Float?   // Parsed numeric (null if non-numeric)
  normalizedUnit   String?  // Converted to canonical unit

  // Flag based on ranges
  flag             String?  // CRITICAL_LOW, LOW, OPTIMAL, HIGH, CRITICAL_HIGH

  // Ranges captured at time of result
  refRangeLow      Float?
  refRangeHigh     Float?
  optimalRangeLow  Float?
  optimalRangeHigh Float?

  isManualEntry    Boolean  @default(false)
  extractionConfidence Float? // 0-1 AI confidence

  providerNote     String?

  createdAt        DateTime @default(now())

  @@index([labPanelId])
  @@index([biomarkerId])
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Float
  sku         String   @unique
  type        String // SUPPLEMENT, RX, LAB_TEST
  
  orderItems  OrderItem[]
  quoteItems  QuoteItem[]
  activeRegimens ActiveRegimen[]
}

model Quote {
  id           String   @id @default(uuid())
  patientId    String
  patient      PatientProfile @relation(fields: [patientId], references: [id])
  conciergeId  String
  concierge    ConciergeProfile @relation(fields: [conciergeId], references: [id])
  
  status       String   @default("PENDING_APPROVAL") // PENDING_APPROVAL, APPROVED, REJECTED
  totalAmount  Float
  validUntil   DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  items        QuoteItem[]
  invoice      Invoice?
}

model QuoteItem {
  id        String  @id @default(uuid())
  quoteId   String
  quote     Quote   @relation(fields: [quoteId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float   // Price at time of quote
}

model Invoice {
  id        String   @id @default(uuid())
  quoteId   String   @unique
  quote     Quote    @relation(fields: [quoteId], references: [id])
  
  amount    Float
  status    String   @default("UNPAID") // UNPAID, PAID, REFUNDED
  paidAt    DateTime?
  
  createdAt DateTime @default(now())
}

model Order {
  id            String   @id @default(uuid())
  patientId     String
  patient       PatientProfile @relation(fields: [patientId], references: [id])
  status        String   @default("PENDING") // PENDING, PROCESSING, SHIPPED, DELIVERED
  totalAmount   Float
  fulfillmentId String? // ID from 3PL
  trackingUrl   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         OrderItem[]
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // VIEW_LAB, EDIT_NOTE, LOGIN, CREATE_QUOTE
  resource  String   // /labs/123
  ipAddress String?
  timestamp DateTime @default(now())
}

model CheckIn {
  id        String   @id @default(uuid())
  patientId String
  patient   PatientProfile @relation(fields: [patientId], references: [id])
  date      DateTime @default(now())
  type      String   @default("MONTHLY") // MONTHLY, QUARTERLY, ADHOC

  metrics   PillarMetric[]
  adherence RegimenAdherence[] // Linking adherence to a snapshot in time

  notes        String? // Free text "What changed?"
  advisorNotes String? // Internal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PillarMetric {
  id        String   @id @default(uuid())
  checkInId String
  checkIn   CheckIn  @relation(fields: [checkInId], references: [id])
  
  category  String // SLEEP, RECOVERY, LIBIDO, MENTAL_ACUITY, DIGESTION, DIET, MOVEMENT
  score     Int    // 1-10
  notes     String?
}

model RegimenAdherence {
  id        String   @id @default(uuid())
  checkInId String
  checkIn   CheckIn  @relation(fields: [checkInId], references: [id])
  
  regimenId String
  regimen   ActiveRegimen @relation(fields: [regimenId], references: [id])
  
  adherent  Boolean // Yes/No
  notes     String? // e.g. "Stopped because of side effects"
}
